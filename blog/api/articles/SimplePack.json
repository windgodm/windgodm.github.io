{"title":"简易压缩壳笔记","uid":"0655b50c19b52b6b171bbab9b69a5ecc","slug":"SimplePack","date":"2021-08-04T04:00:00.000Z","updated":"2021-09-28T10:22:22.726Z","comments":true,"path":"api/articles/SimplePack.json","keywords":null,"cover":null,"content":"<h1 id=\"简易压缩壳笔记\"><a href=\"#简易压缩壳笔记\" class=\"headerlink\" title=\"简易压缩壳笔记\"></a>简易压缩壳笔记</h1><h2 id=\"流程\"><a href=\"#流程\" class=\"headerlink\" title=\"流程\"></a>流程</h2><pre class=\"line-numbers language-none\"><code class=\"language-none\">加壳器：\n读取被加壳文件\n加载壳代码\n复制壳代码的section header\n修改ep并保存oep\n加密\n压缩\n清空import、iat directory，保存import directory\n清空tls directoru，保存directory的AddressOfCallBacks\n重定位壳代码\n复制壳代码重定位表，并修改reloc directory\n修复壳代码重定位表\n写入文件\n\n壳代码：\n遍历ldr获取ntdll中的函数\n获取用于解壳的函数的地址\n解压\n解密\n修复并加密iat\n重定位\ntls\n反调试\n跳转到oep</code></pre>\n\n<h2 id=\"细节\"><a href=\"#细节\" class=\"headerlink\" title=\"细节\"></a>细节</h2><p>替换reloc等section时，只需要修改data directory即可。</p>\n<p>增加section可以只增加header，写入文件时再追加写入。</p>\n<p>通过dll形式写壳代码可以比较方便生成重定位表、iat等。</p>\n<h3 id=\"关于导入表\"><a href=\"#关于导入表\" class=\"headerlink\" title=\"关于导入表\"></a>关于导入表</h3><p>关于加密iat，常见的做法对每一个api申请一块可执行内存作为跳转函数，然后把iat中api地址换成跳转函数地址。<br>此做法需要判断导入表中导入的是函数还是变量。如果是变量显然会出错。我采取的做法是判断地址是否位于dll的text段。</p>\n<p>关于import_descriptor。该结构有OriginalFirstThunk和FirstThunk两个结构体数组的指针。理论上文件中时两个结构体应该都指向同一个地址，加载为image后FT指向IAT的RVA。<br>有时可能会出现OFT为0，只有FT的情况。</p>\n","text":"简易压缩壳笔记流程加壳器： 读取被加壳文件 加载壳代码 复制壳代码的section header 修改ep并保存oep 加密 压缩 清空import、iat directory，保存import directory 清空tls directoru，保存directory的Addr...","link":"","photos":[],"count_time":{"symbolsCount":633,"symbolsTime":"1 mins."},"categories":[{"name":"Windows","slug":"Windows","count":13,"path":"api/categories/Windows.json"}],"tags":[{"name":"windows","slug":"windows","count":13,"path":"api/tags/windows.json"},{"name":"pack","slug":"pack","count":1,"path":"api/tags/pack.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#%E7%AE%80%E6%98%93%E5%8E%8B%E7%BC%A9%E5%A3%B3%E7%AC%94%E8%AE%B0\"><span class=\"toc-text\">简易压缩壳笔记</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%B5%81%E7%A8%8B\"><span class=\"toc-text\">流程</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%BB%86%E8%8A%82\"><span class=\"toc-text\">细节</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%85%B3%E4%BA%8E%E5%AF%BC%E5%85%A5%E8%A1%A8\"><span class=\"toc-text\">关于导入表</span></a></li></ol></li></ol></li></ol>","author":{"name":"御史神风","slug":"御史神风","avatar":"/blog/imgs/child.jpg","link":"/","description":"芜湖~好耶!","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"MEMZ彩虹猫分析","uid":"25dfe92efe3817312d385cfe3a16b7f2","slug":"memz","date":"2021-08-13T04:00:00.000Z","updated":"2021-09-28T10:21:28.040Z","comments":true,"path":"api/articles/memz.json","keywords":null,"cover":[],"text":"MEMZ彩虹猫分析流程 void start() &#123; &#x2F;&#x2F; 紫色部分 if(arbc &gt; 1) &#123; if(!lstrcmpW(argv[1], L&quot;&#x2F;watchdog&quot;)) &#123; &#x2F;&#...","link":"","photos":[],"count_time":{"symbolsCount":"2.1k","symbolsTime":"2 mins."},"categories":[{"name":"Virus","slug":"Virus","count":1,"path":"api/categories/Virus.json"}],"tags":[{"name":"windows","slug":"windows","count":13,"path":"api/tags/windows.json"},{"name":"virus","slug":"virus","count":1,"path":"api/tags/virus.json"}],"author":{"name":"御史神风","slug":"御史神风","avatar":"/blog/imgs/child.jpg","link":"/","description":"芜湖~好耶!","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"WX数据库自动解密（已失效）","uid":"b4fc70e59f23576dbde3f95657ed4ffe","slug":"WeChatDBDecrypt","date":"2021-07-22T04:00:00.000Z","updated":"2021-11-05T11:34:36.242Z","comments":true,"path":"api/articles/WeChatDBDecrypt.json","keywords":null,"cover":null,"text":"微信 PC端 数据库 自动解密摘要 环境: win10家庭中文版 10.0.19043 x64（本机） 微信 3.3.0.115 openssl-1.0.2r PC密码为32字节。 手动流程获取密码打开微信（不点登录）。 打开Odb附加WeChat.exe。 查找-&gt;可执行...","link":"","photos":[],"count_time":{"symbolsCount":"2.9k","symbolsTime":"3 mins."},"categories":[{"name":"Windows","slug":"Windows","count":13,"path":"api/categories/Windows.json"}],"tags":[{"name":"WX","slug":"WX","count":1,"path":"api/tags/WX.json"},{"name":"Database","slug":"Database","count":2,"path":"api/tags/Database.json"}],"author":{"name":"御史神风","slug":"御史神风","avatar":"/blog/imgs/child.jpg","link":"/","description":"芜湖~好耶!","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}
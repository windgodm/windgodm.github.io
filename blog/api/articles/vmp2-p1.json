{"title":"vmp2 (1) 初步分析","uid":"168fbfd9ad872dd1d16955f2d30e829c","slug":"vmp2-p1","date":"2021-09-13T04:00:00.000Z","updated":"2021-09-28T10:29:17.779Z","comments":true,"path":"api/articles/vmp2-p1.json","keywords":null,"cover":null,"content":"<h1 id=\"VMP2（1）初步分析\"><a href=\"#VMP2（1）初步分析\" class=\"headerlink\" title=\"VMP2（1）初步分析\"></a>VMP2（1）初步分析</h1><h2 id=\"摘要\"><a href=\"#摘要\" class=\"headerlink\" title=\"摘要\"></a>摘要</h2><p>初步分析VMProtect Ultimate v 2.13.5加密后的程序，得出vmp基本结构的总结。</p>\n<h2 id=\"基本信息\"><a href=\"#基本信息\" class=\"headerlink\" title=\"基本信息\"></a>基本信息</h2><blockquote><span class=\"custom-blockquote-svg\"><svg width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"\" xmlns=\"http://www.w3.org/2000/svg\" data-reactroot=\"\">\n<path fill=\"\" d=\"M22 12C22 6.5 17.5 2 12 2C6.5 2 2 6.5 2 12C2 17.5 6.5 22 12 22C13.8 22 15.5 21.5 17 20.6L22 22L20.7 17C21.5 15.5 22 13.8 22 12Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\" undefined=\"1\"></path>\n<path fill=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\" undefined=\"1\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M17 8.5C15.23 8.97 14.07 10.84 14.01 13.27C14 13.33 14 13.4 14 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M9 8.5C7.23 8.97 6.07 10.84 6.01 13.27C6 13.33 6 13.4 6 13.47V13.5\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M15.97 11.5H16.04C17.12 11.5 18 12.38 18 13.47V13.53C18 14.62 17.12 15.5 16.03 15.5H15.96C14.88 15.5 14 14.62 14 13.53V13.46C14 12.38 14.88 11.5 15.97 11.5Z\"></path>\n<path stroke-linejoin=\"round\" stroke-linecap=\"round\" stroke-miterlimit=\"10\" stroke-width=\"2\" stroke=\"\" d=\"M7.97 11.5H8.04C9.12 11.5 10 12.38 10 13.47V13.53C10 14.62 9.12 15.5 8.03 15.5H7.97C6.88 15.5 6 14.62 6 13.53V13.46C6 12.38 6.88 11.5 7.97 11.5Z\"></path>\n</svg>\n</span><p>版本：VMProtect Ultimate v 2.13.5</p></blockquote>\n<p>vmp代码在tls中。</p>\n<p>下面是分析出的一些寄存器在vmp中的作用：</p>\n<table>\n<thead>\n<tr>\n<th>寄存器</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>RSI</td>\n<td>字节码数组（逆序）</td>\n</tr>\n<tr>\n<td>R12</td>\n<td>Handler表</td>\n</tr>\n<tr>\n<td>R13</td>\n<td>Handler基址</td>\n</tr>\n<tr>\n<td>RBP</td>\n<td>VMP栈顶指针（栈从高到低）</td>\n</tr>\n<tr>\n<td>RDI</td>\n<td>VMP寄存器指针</td>\n</tr>\n<tr>\n<td>RBX</td>\n<td>解码密钥（动态）</td>\n</tr>\n</tbody></table>\n<p>rsi指向当前字节码，rsi-1指向下一条字节码。</p>\n<h2 id=\"Handler\"><a href=\"#Handler\" class=\"headerlink\" title=\"Handler\"></a>Handler</h2><p>14019065C~140190E54（256个x8byte）</p>\n<h3 id=\"Handler分析\"><a href=\"#Handler分析\" class=\"headerlink\" title=\"Handler分析\"></a>Handler分析</h3><p><strong>POP_Q</strong></p>\n<p>从vmp栈pop8字节数据到指定vmp寄存器。</p>\n<p>2字节命令，后1字节解密后为VMP寄存器偏移（rdi）。</p>\n<pre class=\"line-numbers language-cpp\" data-language=\"cpp\"><code class=\"language-cpp\">&#x2F;&#x2F; 获取pop8目标vmp寄存器的偏移\nunsigned char GetPOP8Offset()\n&#123;\n    unsigned char al, bl;\n    \n    al &#x3D; stack[--_rsi];\n    bl &#x3D; _rbx &amp; 0xff;\n    \n    al -&#x3D; bl;\n    al ^&#x3D; 0x2f;\n    al++;\n    al ^&#x3D; 0xf1;\n    _rbx &#x3D; _rbx - bl + (bl - al); &#x2F;&#x2F; bl -&#x3D; al\n    return al;\n&#125;</code></pre>\n\n<p><strong>PUSH_Q_ID</strong></p>\n<p>从字节码push4字节数据到vmp栈。</p>\n<p>5字节命令，后4字节解密后为数据。</p>\n<p><code>sub rbp, 8</code>：push的数据为4字节，而VMP栈指针减8。</p>\n<p>在最后有如下一段代码</p>\n<pre class=\"line-numbers language-asm\" data-language=\"asm\"><code class=\"language-asm\">lea rax, qword ptr ds:[rdi+0xE0] # 108\ncmp rbp, rax                   # 10D\nja &lt;VmGetHandle&gt;               # 10F</code></pre>\n\n<p>当rbp&gt;rax时跳转到正常代码，rbp是vmp栈顶，可知rbp&gt;rdi+0xE0。</p>\n<p>由此得知虚拟寄存器在低地址、虚拟栈在高地址。</p>\n<pre class=\"line-numbers language-cpp\" data-language=\"cpp\"><code class=\"language-cpp\">&#x2F;&#x2F; 获取push4的数据\nunsigned int GetPUSH4Data()\n&#123;\n    unsigned int eax, ebx;\n    unsigned char _bl;\n    \n    _rsi -&#x3D; 4;\n    eax &#x3D; *(unsigned int*)(stack+_rsi);\n    ebx &#x3D; _rbx &amp; 0xffffffff;\n    \n    bswap(eax);\n    eax ^&#x3D; ebx;\n    eax -&#x3D; 0xcc3ff88a;\n    eax ^&#x3D; 0x9b616bfd;\n    eax &#x3D; !eax;\n    bl &#x3D; _rbx &amp; 0xff;\n    _rbx &#x3D; _rbx - bl + 0xfa; &#x2F;&#x2F; bl &#x3D; 0xfb; bx--;\n    cdqe;\n    return eax;\n&#125;</code></pre>\n\n<p><strong>ADD_Q_Q</strong></p>\n<p>基于栈的二元加法。实现的功能为<code>top2 = top2+top1</code>，<code>top1 = RFLAGS</code>。</p>\n","text":"VMP2（1）初步分析摘要初步分析VMProtect Ultimate v 2.13.5加密后的程序，得出vmp基本结构的总结。 基本信息 版本：VMProtect Ultimate v 2.13.5 vmp代码在tls中。 下面是分析出的一些寄存器在vmp中的作用： 寄存器 描...","link":"","photos":[],"count_time":{"symbolsCount":"1.5k","symbolsTime":"1 mins."},"categories":[{"name":"Re","slug":"Re","count":3,"path":"api/categories/Re.json"}],"tags":[{"name":"re","slug":"re","count":10,"path":"api/tags/re.json"},{"name":"vmp2","slug":"vmp2","count":3,"path":"api/tags/vmp2.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#VMP2%EF%BC%881%EF%BC%89%E5%88%9D%E6%AD%A5%E5%88%86%E6%9E%90\"><span class=\"toc-text\">VMP2（1）初步分析</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%91%98%E8%A6%81\"><span class=\"toc-text\">摘要</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF\"><span class=\"toc-text\">基本信息</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Handler\"><span class=\"toc-text\">Handler</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Handler%E5%88%86%E6%9E%90\"><span class=\"toc-text\">Handler分析</span></a></li></ol></li></ol></li></ol>","author":{"name":"御史神风","slug":"御史神风","avatar":"/blog/imgs/child.jpg","link":"/","description":"芜湖~好耶!","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"vmp2 (2) 初步分析handler(BeaEngine)","uid":"74105a35f31797dc18272c05740bf85c","slug":"vmp2-p2","date":"2021-09-15T04:00:00.000Z","updated":"2021-09-28T10:29:30.457Z","comments":true,"path":"api/articles/vmp2-p2.json","keywords":null,"cover":null,"text":"VMP2（2）初步分析handler(BeaEngine)摘要基于手动初步分析的基础，了解了vmp2的结构以及handler表及解密方式。现在写些工具用于辅助分析。 流程为： 获取handler RVA 分析跳转并dump handler 由subs1(*top = top2)这...","link":"","photos":[],"count_time":{"symbolsCount":"5.4k","symbolsTime":"5 mins."},"categories":[{"name":"Re","slug":"Re","count":3,"path":"api/categories/Re.json"}],"tags":[{"name":"re","slug":"re","count":10,"path":"api/tags/re.json"},{"name":"vmp2","slug":"vmp2","count":3,"path":"api/tags/vmp2.json"},{"name":"BeaEngine","slug":"BeaEngine","count":2,"path":"api/tags/BeaEngine.json"}],"author":{"name":"御史神风","slug":"御史神风","avatar":"/blog/imgs/child.jpg","link":"/","description":"芜湖~好耶!","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"MEMZ彩虹猫分析","uid":"25dfe92efe3817312d385cfe3a16b7f2","slug":"memz","date":"2021-08-13T04:00:00.000Z","updated":"2021-09-28T10:21:28.040Z","comments":true,"path":"api/articles/memz.json","keywords":null,"cover":[],"text":"MEMZ彩虹猫分析流程 void start() &#123; &#x2F;&#x2F; 紫色部分 if(arbc &gt; 1) &#123; if(!lstrcmpW(argv[1], L&quot;&#x2F;watchdog&quot;)) &#123; &#x2F;&#...","link":"","photos":[],"count_time":{"symbolsCount":"2.1k","symbolsTime":"2 mins."},"categories":[{"name":"Virus","slug":"Virus","count":1,"path":"api/categories/Virus.json"}],"tags":[{"name":"windows","slug":"windows","count":18,"path":"api/tags/windows.json"},{"name":"virus","slug":"virus","count":1,"path":"api/tags/virus.json"}],"author":{"name":"御史神风","slug":"御史神风","avatar":"/blog/imgs/child.jpg","link":"/","description":"芜湖~好耶!","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}